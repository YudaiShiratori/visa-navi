name: Auto Issue Processor

on:
  schedule:
    - cron: '0 15 * * *' # JST 00:00 = UTC 15:00
    - cron: '30 9 * * *' # JST 18:30 = UTC 09:30 (テスト用)
  workflow_dispatch:
    inputs:
      max_issues:
        description: '処理する最大Issue数'
        required: false
        default: '10'

jobs:
  collect-issues:
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.filter-issues.outputs.issues }}
      has_issues: ${{ steps.filter-issues.outputs.has_issues }}
    steps:
      - name: Get open issues without linked PRs
        id: filter-issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # オープンIssueを取得
          issues=$(gh issue list --state open --json number,title --limit 50)

          # PRが未作成のIssueをフィルタリング
          filtered_issues="[]"
          for row in $(echo "$issues" | jq -c '.[]'); do
            issue_number=$(echo "$row" | jq -r '.number')
            linked_prs=$(gh pr list --state all --search "Fixes #$issue_number OR Closes #$issue_number" --json number)
            if [ "$(echo "$linked_prs" | jq '. | length')" -eq 0 ]; then
              filtered_issues=$(echo "$filtered_issues" | jq --argjson issue "$row" '. + [$issue]')
            fi
          done

          max_issues=${{ github.event.inputs.max_issues || '10' }}
          filtered_issues=$(echo "$filtered_issues" | jq ".[:$max_issues]")

          echo "issues=$(echo "$filtered_issues" | jq -c '[.[].number]')" >> $GITHUB_OUTPUT
          [ "$(echo "$filtered_issues" | jq '. | length')" -gt 0 ] && echo "has_issues=true" >> $GITHUB_OUTPUT || echo "has_issues=false" >> $GITHUB_OUTPUT

  process-issue:
    needs: collect-issues
    if: needs.collect-issues.outputs.has_issues == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        issue: ${{ fromJson(needs.collect-issues.outputs.issues) }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Run Claude Code for Issue #${{ matrix.issue }}
        timeout-minutes: 20
        id: implement
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Work on Issue #${{ matrix.issue }}.

            1. View issue: gh issue view ${{ matrix.issue }}
            2. Assign yourself: gh issue edit ${{ matrix.issue }} --add-assignee @me
            3. Create branch: git checkout -b fix/issue-${{ matrix.issue }} main
            4. Investigate codebase and implement solution following TDD
            5. Run quality checks: bun run check:write && bun run typecheck && bun run test
            6. Commit: git add . && git commit -m "fix: [description]\n\nFixes #${{ matrix.issue }}"
            7. Push: git push origin fix/issue-${{ matrix.issue }}
            8. Create PR: gh pr create --title "Fix #${{ matrix.issue }}: [title]" --body "Fixes #${{ matrix.issue }}"
            9. Output the PR number at the end in format: PR_NUMBER=<number>

            Follow CLAUDE.md guidelines. If issue is unclear, comment on it instead of creating PR.

          allowed_tools: "Bash(bun add:*),Bash(bun remove:*),Bash(bun install),Bash(bun run test:*),Bash(bun run check:*),Bash(bun run check:write),Bash(bun run check:unsafe),Bash(bun run build),Bash(bun run typecheck),Bash(ls:*),Bash(cat:*),Bash(find:*),Bash(mkdir:*),Bash(touch:*),Bash(mv:*),Bash(cp:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git pull:*),Bash(git checkout:*),Bash(git branch:*),Bash(git diff:*),Bash(git status:*),Bash(git log:*),Bash(echo:*),Bash(grep:*),Bash(gh issue:*),Bash(gh pr:*)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get created PR number
        id: get-pr
        run: |
          # ブランチからPR番号を取得
          pr_number=$(gh pr list --head "fix/issue-${{ matrix.issue }}" --json number --jq '.[0].number')
          if [ -n "$pr_number" ]; then
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "PR #$pr_number が見つかりました"
          else
            echo "PRが見つかりませんでした"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Self-review and fix PR
        timeout-minutes: 10
        if: steps.get-pr.outputs.pr_number != ''
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            自己レビューと修正を行います。PR #${{ steps.get-pr.outputs.pr_number }} をレビューしてください。

            1. PRの変更を確認: gh pr diff ${{ steps.get-pr.outputs.pr_number }}
            2. 以下の観点でレビュー:
               - コード品質とベストプラクティス
               - 潜在的なバグ、パフォーマンス問題、セキュリティ懸念
               - テストカバレッジ
               - CLAUDE.mdのガイドラインへの準拠
            3. 問題が見つかった場合:
               - 修正を実施
               - bun run check:write && bun run typecheck && bun run test を実行
               - git add . && git commit -m "fix: address self-review feedback"
               - git push origin fix/issue-${{ matrix.issue }}
            4. PRにレビューコメントを追加: gh pr comment ${{ steps.get-pr.outputs.pr_number }} --body "## 自己レビュー完了\n\n[レビュー結果と修正内容のサマリー]"

            修正が不要な場合も、レビュー完了のコメントを残してください。

          allowed_tools: "Bash(bun add:*),Bash(bun remove:*),Bash(bun install),Bash(bun run test:*),Bash(bun run check:*),Bash(bun run check:write),Bash(bun run check:unsafe),Bash(bun run build),Bash(bun run typecheck),Bash(ls:*),Bash(cat:*),Bash(find:*),Bash(mkdir:*),Bash(touch:*),Bash(mv:*),Bash(cp:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git pull:*),Bash(git checkout:*),Bash(git branch:*),Bash(git diff:*),Bash(git status:*),Bash(git log:*),Bash(echo:*),Bash(grep:*),Bash(gh issue:*),Bash(gh pr:*)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rate limit protection
        if: always()
        run: sleep 30
